<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editable and Extendable Table</title>
  <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: Sans-Serif;
    }
    .controls {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div>
    <h1>Editable and Extendable Table</h1>
    <div class="controls">
      <button id="addRow">Add Row</button>
    </div>
    <hr>
    <div id="table"></div>
  </div>

  <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
  <script>
    const tableDiv = document.getElementById('table');
    const addRowButton = document.getElementById('addRow');

    const updateUrl = (prev, query) => {
      return prev + (prev.indexOf('?') >= 0 ? '&' : '?') + new URLSearchParams(query).toString();
    };

    const editableCellAttributes = (data, row, col) => {
      if (row) {
        return {
          contentEditable: 'true',
          'data-element-id': row.cells[0].data, // Use hidden ID
          'data-column-id': col.id
        };
      } else {
        return {};
      }
    };

    const grid = new gridjs.Grid({
      columns: [
        { id: 'id', hidden: true }, // Hidden column for unique ID
        { id: 'name', name: 'Name', attributes: editableCellAttributes },
        { id: 'age', name: 'Age', attributes: editableCellAttributes },
        { id: 'address', name: 'Address', attributes: editableCellAttributes },
        { id: 'phone', name: 'Phone Number' },
        { id: 'email', name: 'Email' },
      ],
      server: {
        url: '/api/data',
        then: results => results.data,
        total: results => results.total,
      },
      search: {
        enabled: true,
        server: {
          url: (prev, search) => updateUrl(prev, { search }),
        },
      },
      sort: {
        enabled: true,
        multiColumn: true,
        server: {
          url: (prev, columns) => {
            const columnIds = ['id', 'name', 'age', 'address', 'phone', 'email'];
            const sort = columns.map(col => (col.direction === 1 ? '+' : '-') + columnIds[col.index]);
            return updateUrl(prev, { sort });
          },
        },
      },
      pagination: {
        enabled: true,
        server: {
          url: (prev, page, limit) => updateUrl(prev, { start: page * limit, length: limit }),
        },
      },
    }).render(tableDiv);

    // Handle cell editing
    let savedValue;

    tableDiv.addEventListener('focusin', ev => {
      if (ev.target.tagName === 'TD') {
        savedValue = ev.target.textContent;
      }
    });

    tableDiv.addEventListener('focusout', ev => {
      if (ev.target.tagName === 'TD') {
        if (savedValue !== ev.target.textContent) {
          const id = ev.target.dataset.elementId;
          const column = ev.target.dataset.columnId;
          const value = ev.target.textContent;

          fetch('/api/data', {
            method: id ? 'POST' : 'PUT', // PUT for new rows
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, [column]: value }),
          });
        }
        savedValue = undefined;
      }
    });

    tableDiv.addEventListener('keydown', ev => {
      if (ev.target.tagName === 'TD') {
        if (ev.key === 'Escape') {
          ev.target.textContent = savedValue;
          ev.target.blur();
        } else if (ev.key === 'Enter') {
          ev.preventDefault();
          ev.target.blur();
        }
      }
    });

    // Add new row
    addRowButton.addEventListener('click', () => {
      const blankRow = {
        id: null, // No ID yet
        name: '',
        age: '',
        address: '',
        phone: '',
        email: '',
      };

      fetch('/api/data', {
        method: 'PUT', // PUT to create a new record
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(blankRow),
      })
        .then(response => response.json())
        .then(data => {
          // Reload the table to fetch the new row
          grid.updateConfig({
            server: {
              url: '/api/data',
              then: results => results.data,
            },
          }).forceRender();
        });
    });
  </script>
</body>
</html>
