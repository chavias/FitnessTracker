{% extends 'layout.html' %}

{% block header %}
<script>
    function validateForm() {
        const exercises = document.querySelectorAll('.exercise-row');
        if (exercises.length === 0) {
            alert('Please add at least one exercise.');
            return false;
        }
        for (const exercise of exercises) {
            const name = exercise.querySelector('input[name="exercise[]"]').value.trim();
            if (!name) {
                alert('Exercise name cannot be empty.');
                return false;
            }
        }
        return true;
    }

    window.onload = function () {
        const dateField = document.getElementById("date");
        const today = new Date();
        const formattedDate = today.toISOString().split('T')[0];
        dateField.value = formattedDate;
    };

    let draggedItem = null;

    function loadLastSession(inputField, applyToDetails = false) {
        const exerciseName = inputField.value.trim();
        if (exerciseName) {
            fetch(`/get_last_session/${exerciseName}`)
                .then(response => response.json())
                .then(data => {
                    const parent = inputField.closest('.exercise-row');
                    const detailsList = parent.querySelector('.details-list');

                    if (applyToDetails && data.details) {
                        const existingRows = detailsList.children.length;

                        data.details.forEach((detail, index) => {
                            if (index < existingRows) {
                                const detailRow = detailsList.children[index];
                                detailRow.querySelector('input[name="repetitions[]"]').value = detail.repetitions;
                                detailRow.querySelector('input[name="weight[]"]').value = detail.weight;
                            } else {
                                addDetailRow(detailsList, detail.repetitions, detail.weight, false);
                            }
                        });
                    }
                })
                .catch(error => console.error('Error loading last session:', error));
        }
    }

    function addDetailRow(detailsList, repetitions = '', weight = '', triggerAutocomplete = true) {
        const detailRow = document.createElement('div');
        detailRow.className = 'detail-row';

        detailRow.innerHTML = `
            <input type="number" name="repetitions[]" style="width: 30%" placeholder="Reps" value="${repetitions}" required>
            <input type="number" name="weight[]" style="width: 30%" placeholder="Weight" value="${weight}" step="0.5" required>
            <button type="button" class="remove-button" onclick="removeDetailRow(this)">&#10006;</button>
        `;

        detailsList.appendChild(detailRow);

        if (triggerAutocomplete) {
            // Ensure only the last row is updated with data
            const exerciseNameField = detailsList.closest('.exercise-row').querySelector('input[name="exercise[]"]');
            if (exerciseNameField.value.trim()) {
                fetch(`/get_last_session/${exerciseNameField.value.trim()}`)
                    .then(response => response.json())
                    .then(data => {
                        const lastRow = detailsList.lastElementChild;
                        const detail = data.details[detailsList.children.length - 1];
                        if (detail) {
                            lastRow.querySelector('input[name="repetitions[]"]').value = detail.repetitions;
                            lastRow.querySelector('input[name="weight[]"]').value = detail.weight;
                            console.log('Completed details');
                        }
                        console.log(detail);
                    })
                    .catch(error => console.error('Error autocompleting last detail:', error));
            }
        }
    }


    function addExerciseRow(exercise = '', details = []) {
        const exerciseList = document.getElementById('exercise-list');
        const newRow = document.createElement('div');
        const rowId = `exercise-row-${Date.now()}`;

        newRow.className = 'exercise-row';
        newRow.id = rowId;
        newRow.setAttribute('draggable', 'true');
        newRow.setAttribute('ondragstart', 'drag(event)');
        newRow.setAttribute('ondragover', 'allowDrop(event)');
        newRow.setAttribute('ondrop', 'drop(event)');

        newRow.innerHTML = `
            <input type="text" name="exercise[]" style="width: 80%" value="${exercise}" placeholder="Exercise Name" oninput="loadLastSession(this, true)" required>
            <div class="details-list">
                ${details.map(detail => `<div class='detail-row'>
                    <input type="number" name="repetitions[]" style="width: 30%" value="${detail.repetitions}" placeholder="Reps" required>
                    <input type="number" name="weight[]" style="width: 30%" value="${detail.weight}" placeholder="Weight" step="0.5" required>
                    <button type="button" class="remove-button" onclick="removeDetailRow(this)">&#10006;</button>
                </div>`).join('')}
            </div>
            <button type="button" onclick="addDetailRow(this.closest('.exercise-row').querySelector('.details-list'), '', '')">Set</button>
            <button type="button" class="remove-button" onclick="removeExerciseRow(this)">&#10006;</button>
        `;
        console.log(exerciseList);
        exerciseList.appendChild(newRow);
        return newRow;
    }

    function removeDetailRow(button) {
        button.parentElement.remove();
    }

    function removeExerciseRow(button) {
        button.parentElement.remove();
    }

    function loadTemplate(templateId) {
        const exerciseList = document.getElementById('exercise-list');
        exerciseList.innerHTML = '';

        if (templateId) {
            fetch(`/get_template/${templateId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.exercises) {
                        data.exercises.forEach(exercise => {
                            addExerciseRow(exercise.exercise, exercise.details);
                        });
                    }
                })
                .catch(error => console.error('Error fetching template:', error));
        }
    }

    function allowDrop(event) {
        event.preventDefault();
    }

    function drag(event) {
        draggedItem = event.target;
        event.dataTransfer.setData("text", draggedItem.id);
    }

    function drop(event) {
        event.preventDefault();
        const targetItem = event.target.closest('.exercise-row');
        if (targetItem && draggedItem !== targetItem) {
            const parent = draggedItem.parentNode;
            parent.insertBefore(draggedItem, targetItem.nextSibling);
        }
    }
</script>
{% endblock %}



{% block content %}
<form method="POST">
    {{ form.hidden_tag() }}

    <select name="template_id" id="template" onchange="loadTemplate(this.value)">
        <option value="">Select a Template</option>
        {% for template in templates %}
        <option value="{{ template.id }}">{{ template.name }}</option>
        {% endfor %}
    </select>
    <br>

    <input type="date" name="date" id="date" required>

    <div id="exercise-list">
        {% for exercise_form in form.exercises %}
        <div class="exercise-row">
            <input type="text" name="exercise[]" style="width: 80%" value="{{ exercise_form.name.data }}" placeholder="Exercise Name" oninput="loadLastSession(this, true)" required>
            <div class="details-list">
                {% for detail_form in exercise_form.details %}
                <div class="detail-row">
                    <input type="number"  name="repetitions[]" style="width: 30%" value="{{ detail_form.repetitions.data }}" placeholder="Reps" required>
                    <input type="number" name="weight[]" style="width: 30%" value="{{ detail_form.weight.data }}" placeholder="Weight" step="0.5" required>
                    <!-- {{ detail_form.repetitions.label }} {{ detail_form.repetitions }}
                    {{ detail_form.weight.label }} {{ detail_form.weight }} -->
                    {{ detail_form.csrf_token }}
                    <button type="button" class="remove-button" onclick="removeDetailRow(this)">&#10006;</button>
                </div>
                {% endfor %}
            </div>
            <button type="button" onclick="addDetailRow(this.closest('.exercise-row').querySelector('.details-list'), '', '')">set</button>
            <button type="button" class="remove-button" onclick="removeExerciseRow(this)">&#10006;</button>
        </div>
        {{ exercise_form.csrf_token }}
        {% endfor %}
    </div>
    <button type="button" onclick="addExerciseRow()" style="margin-bottom: 1cm;">Add Exercise</button>
    <button type="submit" value="true">Submit Session</button>
</form>

{% if form.errors %}
    <ul>
        {% for field, errors in form.errors.items() %}
        <li><strong>{{ field }}</strong>: {{ errors }}</li>
        {% endfor %}
    </ul>
{% endif %}


{% if form %}
    <h3>Form Values</h3>
    <ul>
        {% for field in form %}
            <li><strong>{{ field.label }}:</strong> {{ field.data}}</li>
        {% endfor %}
    </ul>
{% endif %}

{% endblock %}