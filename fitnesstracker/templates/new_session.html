{% extends 'layout.html' %}

{% block header %}
    <meta charset="UTF-8">
    <title>New Session</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function () {
            let exerciseIndex = {{ form.exercises | length }};
            const csrf_token = "{{ form.csrf_token._value() }}";  // Get CSRF token value from the parent form

            // Add new exercise
            $('#addExercise').click(function () {
                const exerciseHtml = `
                <div class="exercise-item">
                    <div>
                        <label for="exercises-${exerciseIndex}-name">Exercise Name</label>
                        <input id="exercises-${exerciseIndex}-name" name="exercises-${exerciseIndex}-name" type="text">
                        <input type="hidden" name="exercises-${exerciseIndex}-csrf_token" value="${csrf_token}">
                        <button type="button" class="remove-exercise">Remove Exercise</button>
                    </div>
                    <div class="details"></div>
                    <button type="button" class="add-detail">Add Detail</button>
                </div>`;
                
                $('#exerciseList').append(exerciseHtml);
                exerciseIndex++;
            });

            // Remove an exercise
            $(document).on('click', '.remove-exercise', function () {
                $(this).closest('.exercise-item').remove();
            });

            // Add a new detail to an exercise
            $(document).on('click', '.add-detail', function () {
                const detailsDiv = $(this).siblings('.details');
                const detailIndex = detailsDiv.children('.detail-item').length;
                const exerciseIndex = $(this).closest('.exercise-item').index();

                const detailHtml = `
                <div class="detail-item">
                    <label for="exercises-${exerciseIndex}-details-${detailIndex}-repetitions">Repetitions</label>
                    <input id="exercises-${exerciseIndex}-details-${detailIndex}-repetitions" 
                           name="exercises-${exerciseIndex}-details-${detailIndex}-repetitions" type="number">
                    
                    <label for="exercises-${exerciseIndex}-details-${detailIndex}-weight">Weight (kg)</label>
                    <input id="exercises-${exerciseIndex}-details-${detailIndex}-weight" 
                           name="exercises-${exerciseIndex}-details-${detailIndex}-weight" type="number">
                    
                    <button type="button" class="remove-detail">Remove Detail</button>
                </div>`;
                
                detailsDiv.append(detailHtml);
            });

            // Remove a detail
            $(document).on('click', '.remove-detail', function () {
                $(this).closest('.detail-item').remove();
            });
        });
    </script>
{% endblock %}

{% block content %}
    <form method="POST" id="sessionForm">
        {{ form.hidden_tag() }}  <!-- Hidden CSRF token for the main form -->
        <div id="exerciseList">
            {% for exercise_form in form.exercises %}
                <div class="exercise-item">
                    <div>
                        <label>Exercise Name:</label>
                        {{ exercise_form.name }}
                        <!-- Manually add CSRF token for each exercise form -->
                        {{ exercise_form.csrf_token }}
                        <button type="button" class="remove-exercise">Remove Exercise</button>
                    </div>
                    <div class="details">
                        {% for detail_form in exercise_form.details %}
                            <div class="detail-item">
                                {{ detail_form.repetitions.label }} {{ detail_form.repetitions }}
                                {{ detail_form.weight.label }} {{ detail_form.weight }}
                                {{ detail_form.csrf_token }}
                                <button type="button" class="remove-detail">Remove Detail</button>
                            </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="add-detail">Add Detail</button>
                </div>
            {% endfor %}
        </div>
        
        <button type="button" id="addExercise">Add Exercise</button>
        <button type="submit">{{ form.submit.label }}</button>
    </form>

    {% if form.errors %}
        <ul>
        {% for field, errors in form.errors.items() %}
            <li><strong>{{ field }}</strong>: {{ errors[0] }}</li>
        {% endfor %}
        </ul>
    {% endif %}
{% endblock %}
