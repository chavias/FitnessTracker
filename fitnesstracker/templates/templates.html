{% extends 'layout.html' %}

{% block header %}
<script>
    // Global variable to store the dragged element
    let draggedItem = null;

    // Allow the dragged item to be dropped
    function allowDrop(event) {
        event.preventDefault();
    }

    // Handle the start of a drag event
    function drag(event) {
        draggedItem = event.target;
    }

    // Handle the drop event to swap the elements
    function drop(event) {
        event.preventDefault();
        const targetItem = event.target.closest('.exercise-row');
        if (targetItem && draggedItem !== targetItem) {
            // Swap the dragged item with the target item
            const parent = draggedItem.parentNode;
            parent.insertBefore(draggedItem, targetItem.nextSibling);

            // Update the indices for the input fields after reordering
            updateIndices();
        }
    }

    // Update the indices for the input field names after reordering
    function updateIndices() {
        const exerciseRows = document.querySelectorAll('.exercise-row');
        exerciseRows.forEach((row, index) => {
            const inputField = row.querySelector('input[name^="exercises"]');
            const newName = `exercises-${index}-exercise_name`;
            inputField.setAttribute('name', newName);
        });
    }

    // Function to remove an exercise row
    function removeExerciseRow(button) {
        const row = button.parentElement;
        row.remove();
        updateIndices();  // Re-index the remaining fields after removal
    }

    // Function to add a new exercise row (for dynamic addition)
    function addExerciseRow() {
        const exerciseList = document.getElementById('exercise-list');
        const newIndex = exerciseList.children.length;

        // Create a new exercise row with input fields
        const newRow = document.createElement('div');
        newRow.classList.add('exercise-row');
        newRow.setAttribute('id', `exercise-${newIndex}`);
        newRow.setAttribute('draggable', 'true');
        newRow.setAttribute('ondragstart', 'drag(event)');
        newRow.setAttribute('ondragover', 'allowDrop(event)');
        newRow.setAttribute('ondrop', 'drop(event)');

        newRow.innerHTML = `
            <input type="text" name="exercises-${newIndex}-exercise_name" placeholder="Exercise Name" required>
            <button type="button" onclick="removeExerciseRow(this)">&#10006;</button>
        `;
        exerciseList.appendChild(newRow);
    }
</script>
{% endblock %}

{% block content %}
<div class="content-section">
    <form method="POST">
        {{ form.hidden_tag() }}

        <!-- Template Name -->
        <div class="form-group">
            <input type="text" name="template_name" value="{{ form.template_name.data or '' }}"
                placeholder="{{ form.template_name.label.text }}" size="40" required>
        </div>

        <!-- Exercises List -->
        <div id="exercise-list">
            {% for subform in form.exercises %}
            <div class="exercise-row" id="exercise-{{ loop.index0 }}" draggable="true" ondragstart="drag(event)"
                ondragover="allowDrop(event)" ondrop="drop(event)">
                <input type="text" name="exercises-{{ loop.index0 }}-exercise_name"
                    value="{{ subform.exercise_name.data or '' }}" placeholder="Exercise Name" required>
                {{ subform.csrf_token }}
                <button type="button" onclick="removeExerciseRow(this)">&#10006;</button>
            </div>
            {% endfor %}
        </div>

        <button type="button" onclick="addExerciseRow()">Add Exercise</button><br><br>
        <button type="submit" name="submit" value="true">Create Template</button>
    </form>
</div>
{% if form %}
<h3>Form Values</h3>
<ul>
    {% for field in form %}
    <li><strong>{{ field.label }}:</strong> {{ field.data}}</li>
    {% endfor %}
</ul>
{% endif %}




{% for template in templates %}
<article class="media content-section">
    <div class="media-body">
        <div class="article-metadata">
            <a class="article-title" href="{{ url_for('template', template_id=template.id) }}">{{ template.name }}</a>
        </div>
        <p class="article-content">
            {% for exercise in template_data[template.id] %}
            <li>{{ exercise }}</li>
            {% endfor %}
        </p>
    </div>
</article>
{% endfor %}




{% endblock %}